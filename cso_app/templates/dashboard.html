<!DOCTYPE html>
<html>
<head>
    <title>CSO Dashboard</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #map { height: 400px; width: 100%; margin-bottom: 30px; }
        canvas { margin-top: 20px; }
        h1 { margin-bottom: 10px; }
    </style>
</head>

<body>

<h1>CSO Event Dashboard</h1>

<a href="/export/xlsx/" style="
    padding:10px; background:#007bff; color:white; text-decoration:none;
    border-radius:5px; font-weight:bold;">
Download XLSX
</a>


<div id="map"></div>

<h2>Overflow Volume by Event</h2>
<canvas id="volumeChart" width="400" height="200"></canvas>


<script>
    const events = {{ events|safe }};

    var map = L.map('map').setView([40.4406, -79.9959], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    const redIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34]
    });

    const orangeIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34]
    });

    const greenIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34]
    });

    events.forEach(event => {

        let markerIcon = greenIcon;  

        if (event.severity.toLowerCase() === "high") {
            markerIcon = redIcon;
        } else if (event.severity.toLowerCase() === "medium") {
            markerIcon = orangeIcon;
        }

        L.marker([event.lat, event.lng], { icon: markerIcon })
            .addTo(map)
            .bindPopup(`
                <b>Location:</b> ${event.location}<br>
                <b>Severity:</b> ${event.severity}<br>
                <b>Volume:</b> ${event.volume} m³<br>
                <b>Start Time:</b> ${event.start_time}
            `);
    });

    const labels = events.map(e => e.location);
    const volumes = events.map(e => e.volume);

    const ctx = document.getElementById('volumeChart');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Overflow Volume (m³)',
                data: volumes,
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

</script>

</body>
</html>
